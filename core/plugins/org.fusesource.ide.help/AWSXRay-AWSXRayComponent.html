<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>AWS XRay Component</title><link rel="stylesheet" type="text/css" href="eclipse_book.css"><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><link rel="home" href="index.html" title="Red Hat Fuse Tooling"><link rel="up" href="IDU-Components.html" title="Part&nbsp;V.&nbsp;Apache Camel Component Reference"><link rel="prev" href="aws-swf-component.html" title="AWS Simple Workflow Component"><link rel="next" href="Azure-CamelComponentsforWindowsAzureServices.html" title="Camel Components for Windows Azure Services"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="AWSXRay-AWSXRayComponent"></a>AWS XRay Component</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="AWSXRay-AWSXRayComponent.html#_dependency">Dependency</a></span></dt><dt><span class="section"><a href="AWSXRay-AWSXRayComponent.html#_configuration">Configuration</a></span></dt><dt><span class="section"><a href="AWSXRay-AWSXRayComponent.html#_example">Example</a></span></dt></dl></div><p><span class="strong"><strong>Available as of Camel 2.21</strong></span></p><p>The camel-aws-xray component is used for tracing and timing incoming and outgoing Camel messages using <a class="link" href="https://aws.amazon.com/de/xray/" target="_top">AWS XRay</a>.</p><p>Events (subsegments) are captured for incoming and outgoing messages being sent to/from Camel.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_dependency"></a>Dependency</h2></div></div></div><p>In order to include AWS XRay support into Camel, the archive containing the Camel related AWS XRay related classes need to be added to the project. In addition to that, AWS XRay libraries also need to be available.</p><p>To include both, AWS XRay and Camel, dependencies use the following Maven imports:</p><pre class="programlisting">  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependencyManagement&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.amazonaws<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>aws-xray-recorder-sdk-bom<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;version&gt;</strong>1.3.1<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;type&gt;</strong>pom<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/type&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;scope&gt;</strong>import<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/scope&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/dependencies&gt;</strong>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/dependencyManagement&gt;</strong>

  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>org.apache.camel<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>camel-aws-xray<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>

      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.amazonaws<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>aws-xray-recorder-sdk-core<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.amazonaws<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
        <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>aws-xray-recorder-sdk-aws-sdk<strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
      <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;dependencies&gt;</strong></pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_configuration"></a>Configuration</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="AWSXRay-AWSXRayComponent.html#_explicit">Explicit</a></span></dt><dt><span class="section"><a href="AWSXRay-AWSXRayComponent.html#_tracking_of_comprehensive_route_execution">Tracking of comprehensive route execution</a></span></dt></dl></div><p>The configuration properties for the AWS XRay tracer are:</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="10%" class="col_1"><col width="10%" class="col_2"><col width="80%" class="col_3"></colgroup><thead><tr><th align="left" valign="top">Option</th><th align="left" valign="top">Default</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>addExcludePatterns</p></td><td align="left" valign="top"><p>&nbsp;</p></td><td align="left" valign="top"><p>Sets exclude pattern(s) that will disable tracing for Camel
messages that matches the pattern. The content is a Set&lt;String&gt; where the key is a pattern matching routeId&#8217;s. The pattern
uses the rules from Intercept.</p></td></tr><tr><td align="left" valign="top"><p>setTracingStrategy</p></td><td align="left" valign="top"><p>NoopTracingStrategy</p></td><td align="left" valign="top"><p>Allows a custom Camel <code class="literal">InterceptStrategy</code> to be provided in order to track invoked processor definitions like <code class="literal">BeanDefinition</code> or <code class="literal">ProcessDefinition</code>. <code class="literal">TraceAnnotatedTracingStrategy</code> will track any classes invoked via <code class="literal">.bean(&#8230;&#8203;)</code> or <code class="literal">.process(&#8230;&#8203;)</code> that contain a <code class="literal">@XRayTrace</code> annotation at class level.</p></td></tr></tbody></table></div><p>There is currently only one way an AWS XRay tracer can be configured to provide distributed tracing for a Camel application:</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_explicit"></a>Explicit</h3></div></div></div><p>Include the <code class="literal">camel-aws-xray</code> component in your POM, along with any specific dependencies associated with the AWS XRay Tracer.</p><p>To explicitly configure AWS XRay support, instantiate the <code class="literal">XRayTracer</code> and initialize the camel
context. You can optionally specify a <code class="literal">Tracer</code>, or alternatively it can be implicitly discovered using the
<code class="literal">Registry</code> or <code class="literal">ServiceLoader</code>.</p><pre class="programlisting">XRayTracer xrayTracer = <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-keyword">new</strong> XRayTracer();
<em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// By default it uses a NoopTracingStrategy, but you can override it with a specific InterceptStrategy implementation.</em>
xrayTracer.setTracingStrategy(...);
<em xmlns="http://www.w3.org/1999/xhtml" class="hl-comment" style="color: silver">// And then initialize the context</em>
xrayTracer.init(camelContext);</pre><p>To use XRayTracer in XML, all you need to do is to define the
AWS XRay tracer bean. Camel will automatically discover and use it.</p><pre class="programlisting">  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"tracingStrategy"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"..."</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;bean</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">id</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"aws-xray-tracer"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">class</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"org.apache.camel.component.aws.xray.XRayTracer"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096"> /&gt;</strong>
    <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;property</strong> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">name</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"tracer"</span> <span xmlns="http://www.w3.org/1999/xhtml" class="hl-attribute" style="color: #F5844C">ref</span>=<span xmlns="http://www.w3.org/1999/xhtml" class="hl-value" style="color: #993300">"tracingStrategy"</span><strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">/&gt;</strong>
  <strong xmlns="http://www.w3.org/1999/xhtml" class="hl-tag" style="color: #000096">&lt;/bean&gt;</strong></pre><p>In case of the default <code class="literal">NoopTracingStrategy</code> only the creation and deletion of exchanges is tracked but not the invocation of certain beans or EIP patterns.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_tracking_of_comprehensive_route_execution"></a>Tracking of comprehensive route execution</h3></div></div></div><p>In order to track the execution of an exchange among multiple routes, on exchange creation a unique trace ID is generated and stored in the headers if no corresponding value was yet available. This trace ID is copied over to new exchanges in order to keep a consistent view of the processed exchange.</p><p>As AWS XRay traces work on a thread-local basis the current sub/segment should be copied over to the new thread and set as explained in <a class="link" href="https://docs.aws.amazon.com/xray/latest/devguide/xray-sdk-java-multithreading.html" target="_top">in the AWS XRay documentation</a>. The Camel AWS XRay component therefore provides an additional header field that the component will use in order to set the passed AWS XRay <code class="literal">Entity</code> to the new thread and thus keep the tracked data to the route rather than exposing a new segment which seems uncorrelated with any of the executed routes.</p><p>The component will use the following constants found in the headers of the exchange:</p><div class="informaltable"><table border="1" width="100%"><colgroup><col width="30%" class="col_1"><col width="70%" class="col_2"></colgroup><thead><tr><th align="left" valign="top">Header</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>Camel-AWS-XRay-Trace-ID</p></td><td align="left" valign="top"><p>Contains a reference to the AWS XRay <code class="literal">TraceID</code> object to provide a comprehensive view of the invoked routes</p></td></tr><tr><td align="left" valign="top"><p>Camel-AWS-XRay-Trace-Entity</p></td><td align="left" valign="top"><p>Contains a reference to the actual AWS XRay <code class="literal">Segment</code> or <code class="literal">Subsegment</code> which is copied over to the new thread. This header should be set in case a new thread is spawned and the performed tasks should be exposed as part of the executed route instead of creating a new unrelated segment.</p></td></tr></tbody></table></div><p>Note that the AWS XRay <code class="literal">Entity</code> (i.e., <code class="literal">Segment</code> and <code class="literal">Subsegment</code>) are not serializable and therefore should not get passed to other JVM processes.</p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_example"></a>Example</h2></div></div></div><p>You can find an example demonstrating the way to configure AWS XRay tracing within the tests accompanying this project.</p></div></div></body></html>