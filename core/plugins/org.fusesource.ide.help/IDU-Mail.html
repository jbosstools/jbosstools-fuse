<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Mail</title><link rel="stylesheet" type="text/css" href="eclipse_book.css"><meta name="generator" content="DocBook XSL Stylesheets V1.77.1"><meta name="keywords" content="ESB, Apache ServiceMix, Open Source, open source, integration, OSGi, enterprise service bus, Apache ServiceMix documentation, Apache Karaf, Red Hat JBoss Fuse, Red Hat JBoss Fuse documentation"><meta name="keywords" content="ESB, Apache ServiceMix, Open Source, open source, integration, OSGi, enterprise service bus, Apache ServiceMix documentation, Apache Karaf, Red Hat JBoss Fuse, Red Hat JBoss Fuse documentation"><link rel="home" href="index.html" title="Red Hat JBoss Fuse Tooling for Eclipse"><link rel="up" href="IDU-Components.html" title="Apache Camel Component Reference"><link rel="prev" href="Lumberjack-LumberjackUsageSamples.html" title="Lumberjack Usage Samples"><link rel="next" href="Master.html" title="Master Component"><link rel="copyright" href="tmdisclaim.html" title="Trademark Disclaimer"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="IDU-Mail"></a>Mail</h1></div></div></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_MailComponent"></a>Mail Component</h2></div></div></div><p>The mail component provides access to Email via Spring's Mail support and the
            underlying JavaMail system.</p><p>Maven users will need to add the following dependency to their
                <code class="literal">pom.xml</code> for this component:</p><pre class="programlisting">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;
    &lt;artifactId&gt;camel-mail&lt;/artifactId&gt;
    &lt;version&gt;x.x.x&lt;/version&gt;
    &lt;!-- use the same version as your Camel core version --&gt;
&lt;/dependency&gt;</pre><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning: Geronimo mail .jar"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="imagesdb/warning.png"></td><th align="left">Geronimo mail .jar</th></tr><tr><td align="left" valign="top"><p>We have discovered that the geronimo mail <code class="literal">.jar</code> (v1.6) has a bug
                when polling mails with attachments. It cannot correctly identify the
                    <code class="literal">Content-Type</code>. So, if you attach a <code class="literal">.jpeg</code>
                file to a mail and you poll it, the <code class="literal">Content-Type</code> is resolved as
                    <code class="literal">text/plain</code> and not as <code class="literal">image/jpeg</code>. For that
                reason, we have added an
                    <code class="literal">org.apache.camel.component.ContentTypeResolver</code> SPI interface
                which enables you to provide your own implementation and fix this bug by returning
                the correct Mime type based on the file name. So if the file name ends with
                    <code class="literal">jpeg/jpg</code>, you can return
                <code class="literal">image/jpeg</code>.</p><p>You can set your custom resolver on the <code class="literal">MailComponent</code> instance
                or on the <code class="literal">MailEndpoint</code> instance.</p></td></tr></table></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: POP3 or IMAP"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="imagesdb/tip.png"></td><th align="left">POP3 or IMAP</th></tr><tr><td align="left" valign="top"><p>POP3 has some limitations and end users are encouraged to use IMAP if
                possible.</p></td></tr></table></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Using mock-mail for testing"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="imagesdb/important.png"></td><th align="left">Using mock-mail for testing</th></tr><tr><td align="left" valign="top"><p>You can use a mock framework for unit testing, which allows you to test without
                the need for a real mail server. However you should remember to not include the
                mock-mail when you go into production or other environments where you need to send
                mails to a real mail server. Just the presence of the mock-javamail.jar on the
                classpath means that it will kick in and avoid sending the mails.</p></td></tr></table></div></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d0e125055"></a>Camel on EAP deployment</h2></div></div></div><p>This component is supported by the Camel on EAP (Wildfly Camel) framework, which
            offers a simplified deployment model on the Red Hat JBoss Enterprise Application Platform (JBoss EAP) container.
 </p><p>By default, Camel creates its own mail session and uses this session to interact with
            your mail server. However, JBoss EAP already provides a mail subsystem with all the
            relevant support for secure connections, username and password encryption, and so on. It
            is recommended that you configure your mail sessions within the JBoss EAP configuration
            and use JNDI to wire them into your Camel endpoints. </p><p>For more information, see <a class="link" href="https://wildflyext.gitbooks.io/wildfly-camel/content/components/camel-mail.html" target="_top">Camel-Mail Configuration</a>.</p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_URIformat"></a>URI format</h2></div></div></div><p>Mail endpoints can have one of the following URI formats (for the protocols, SMTP,
            POP3, or IMAP, respectively):</p><pre class="programlisting">smtp://[username@]host[:port][?options]
pop3://[username@]host[:port][?options]
imap://[username@]host[:port][?options]</pre><p>The mail component also supports secure variants of these protocols (layered over
            SSL). You can enable the secure protocols by adding <code class="literal">s</code> to the
            scheme:</p><pre class="programlisting">smtps://[username@]host[:port][?options]
pop3s://[username@]host[:port][?options]
imaps://[username@]host[:port][?options]</pre><p>You can append query options to the URI in the following format,
                <code class="literal">?option=value&amp;option=value&amp;...</code>
        </p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Sampleendpoints"></a>Sample endpoints</h2></div></div></div><p>Typically, you specify a URI with login credentials as follows (taking SMTP as an
            example):</p><pre class="programlisting">smtp://[username@]host[:port][?password=somepwd]</pre><p>Alternatively, it is possible to specify both the user name and the password as query
            options:</p><pre class="programlisting">smtp://host[:port]?password=somepwd&amp;username=someuser</pre><p>For example:</p><pre class="programlisting">smtp://mycompany.mailserver:30?password=tiger&amp;username=scott</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_anchorDefaultPortsDefaultports"></a>Default ports</h2></div></div></div><p>Default port numbers are supported. If the port number is omitted, Camel determines
            the port number to use based on the protocol.
            
        </p><table id="d0e125111"><tr>
                <th> Protocol </th>
                <th> Default Port Number </th>
            </tr><tr>
                <td><code class="literal">SMTP</code>
                </td>
                <td><code class="literal">25</code>
                </td>
            </tr><tr>
                <td><code class="literal">SMTPS</code>
                </td>
                <td><code class="literal">465</code>
                </td>
            </tr><tr>
                <td><code class="literal">POP3</code>
                </td>
                <td><code class="literal">110</code>
                </td>
            </tr><tr>
                <td><code class="literal">POP3S</code>
                </td>
                <td><code class="literal">995</code>
                </td>
            </tr><tr>
                <td><code class="literal">IMAP</code>
                </td>
                <td><code class="literal">143</code>
                </td>
            </tr><tr>
                <td><code class="literal">IMAPS</code>
                </td>
                <td><code class="literal">993</code>
                </td>
            </tr></table></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Options"></a>Options</h2></div></div></div><p>
            
        </p><table id="d0e125200"><tr>
                <th> Property </th>
                <th> Default </th>
                <th> Description </th>
            </tr><tr>
                <td><code class="literal">host</code>
                </td>
                <td></td>
                <td> The host name or IP address to connect to. </td>
            </tr><tr>
                <td><code class="literal">port</code>
                </td>
                <td> See <a class="xref" href="IDU-Mail.html#IDU-Mail_HSH_anchorDefaultPortsDefaultports" title="Default ports">Default ports</a>.
                </td>
                <td> The TCP port number to connect on. </td>
            </tr><tr>
                <td><code class="literal">username</code>
                </td>
                <td></td>
                <td> The user name on the email server. </td>
            </tr><tr>
                <td><code class="literal">password</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> The password on the email server. </td>
            </tr><tr>
                <td><code class="literal">ignoreUriScheme</code>
                </td>
                <td><code class="literal">false</code>
                </td>
                <td> If <code class="literal">false</code>, Camel uses the scheme to determine the transport
                    protocol (POP, IMAP, SMTP etc.) </td>
            </tr><tr>
                <td><code class="literal">contentType</code>
                </td>
                <td><code class="literal">text/plain</code>
                </td>
                <td> The mail message content type. Use <code class="literal">text/html</code> for HTML mails.
                </td>
            </tr><tr>
                <td><code class="literal">folderName</code>
                </td>
                <td><code class="literal">INBOX</code>
                </td>
                <td> The folder to poll. </td>
            </tr><tr>
                <td><code class="literal">destination</code>
                </td>
                <td><code class="literal">username@host</code>
                </td>
                <td>
                    <span class="bold"><strong>@deprecated</strong></span> Use the <code class="literal">to</code>
                    option instead. The <code class="literal">TO</code> recipients (receivers of the email).
                </td>
            </tr><tr>
                <td><code class="literal">to</code>
                </td>
                <td><code class="literal">username@host</code>
                </td>
                <td> The TO recipients (the receivers of the mail). Separate multiple email
                    addresses with a comma. Email addresses containing special characters such as
                        <code class="code">&amp;</code> must be enclosed in the <code class="code">RAW()</code> function,
                    which can be used to bypass URI encoding.</td>
            </tr><tr>
                <td><code class="literal">replyTo</code>
                </td>
                <td><code class="literal">alias@host</code>
                </td>
                <td> As of <span class="bold"><strong>Camel 2.8.4, 2.9.1\+</strong></span>, the Reply-To
                    recipients (the receivers of the response mail). Separate multiple email
                    addresses with a comma. </td>
            </tr><tr>
                <td><code class="literal">CC</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td>The CC recipients (the receivers of the mail). Separate multiple email addresses
                    with a comma. </td>
            </tr><tr>
                <td><code class="literal">BCC</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> The BCC recipients (the receivers of the mail). Separate multiple email
                    addresses with a comma. </td>
            </tr><tr>
                <td><code class="literal">from</code>
                </td>
                <td><code class="literal">camel@localhost</code>
                </td>
                <td> The FROM email address. </td>
            </tr><tr>
                <td><code class="literal">subject</code>
                </td>
                <td></td>
                <td> As of <span class="bold"><strong>Camel 2.3</strong></span>, the Subject of the message
                    being sent. Note: Setting the subject in the header takes precedence over this
                    option. </td>
            </tr><tr>
                <td class="confluenceTd"><p><code class="code">peek</code></p></td>
                <td class="confluenceTd"><p><code class="code">true</code></p></td>
                <td class="confluenceTd"><p><span class="emphasis"><em>Camel 2.11.3/2.12.2:</em></span> Consumer
                        only. Will mark the <code class="code">javax.mail.Message</code> as peeked before
                        processing the mail message. This applies to <code class="code">IMAPMessage</code>
                        messages types only. By using peek the mail will not be eager marked as
                            <code class="code">SEEN</code> on the mail server, which allows us to roll back the
                        mail message if there is an error processing in Camel.</p></td>
            </tr><tr>
                <td><code class="literal">delete</code>
                </td>
                <td><code class="literal">false</code>
                </td>
                <td> Deletes the messages after they have been processed. This is done by setting
                    the <code class="literal">DELETED</code> flag on the mail message. If
                        <code class="literal">false</code>, the <code class="literal">SEEN</code> flag is set instead.
                    As of <span class="bold"><strong>Camel 2.10</strong></span> you can override this
                    configuration option by setting a header with the key <code class="literal">delete</code>
                    to determine if the mail should be deleted or not. </td>
            </tr><tr>
                <td><code class="literal">unseen</code>
                </td>
                <td><code class="literal">true</code>
                </td>
                <td> It is possible to configure a consumer endpoint so that it processes only
                    unseen messages (that is, new messages) or all messages. Note that Camel always
                    skips deleted messages. The default option of <code class="literal">true</code> will
                    filter to only unseen messages. POP3 does not support the
                        <code class="literal">SEEN</code> flag, so this option is not supported in POP3; use
                    IMAP instead. <span class="bold"><strong>Important:</strong></span> This option is
                        <span class="bold"><strong>not</strong></span> in use if you also use
                        <code class="literal">searchTerm</code> options. Instead if you want to disable unseen
                    when using <code class="literal">searchTerm</code>'s then add
                        <code class="literal">searchTerm.unseen=false</code> as a term. </td>
            </tr><tr>
                <td><code class="literal">copyTo</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td>
                    <span class="bold"><strong>Camel 2.10:</strong></span> Consumer only. After processing a
                    mail message, it can be copied to a mail folder with the given name. You can
                    override this configuration value, with a header with the key
                        <code class="literal">copyTo</code>, allowing you to copy messages to folder names
                    configured at runtime. </td>
            </tr><tr>
                <td><code class="literal">fetchSize</code>
                </td>
                <td><code class="literal">\-1</code>
                </td>
                <td> Sets the maximum number of messages to consume during a poll. This can be used
                    to avoid overloading a mail server, if a mailbox folder contains a lot of
                    messages. Default value of <code class="literal">\-1</code> means no fetch size and all
                    messages will be consumed. Setting the value to 0 is a special corner case,
                    where Camel will not consume any messages at all. </td>
            </tr><tr>
                <td><code class="literal">alternativeBodyHeader</code>
                </td>
                <td><code class="literal">CamelMailAlternativeBody</code>
                </td>
                <td> Specifies the key to an IN message header that contains an alternative email
                    body. For example, if you send emails in <code class="literal">text/html</code> format and
                    want to provide an alternative mail body for non-HTML email clients, set the
                    alternative mail body with this key as a header. </td>
            </tr><tr>
                <td><code class="literal">debugMode</code>
                </td>
                <td><code class="literal">false</code>
                </td>
                <td> Enable debug mode on the underlying mail framework. The SUN Mail framework logs
                    the debug messages to <code class="literal">System.out</code> by default. </td>
            </tr><tr>
                <td><code class="literal">connectionTimeout</code>
                </td>
                <td><code class="literal">30000</code>
                </td>
                <td> The connection timeout in milliseconds. Default is 30 seconds. </td>
            </tr><tr>
                <td><code class="literal">consumer.initialDelay</code>
                </td>
                <td><code class="literal">1000</code>
                </td>
                <td> Milliseconds before the polling starts. </td>
            </tr><tr>
                <td><code class="literal">consumer.delay</code>
                </td>
                <td><code class="literal">60000</code>
                </td>
                <td> Camel will poll the mailbox only once a minute by default to avoid overloading
                    the mail server. </td>
            </tr><tr>
                <td><code class="literal">consumer.useFixedDelay</code>
                </td>
                <td><code class="literal">false</code>
                </td>
                <td> Set to <code class="literal">true</code> to use a fixed delay between polls, otherwise
                    fixed rate is used. See <a class="link" href="http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/ScheduledExecutorService.html" target="_top">ScheduledExecutorService</a> in JDK for details. </td>
            </tr><tr>
                <td><code class="literal">disconnect</code>
                </td>
                <td><code class="literal">false</code>
                </td>
                <td><span class="bold"><strong>Camel 2.8.3/2.9:</strong></span> Whether the consumer should
                    disconnect after polling. If enabled this forces Camel to connect on each poll.
                </td>
            </tr><tr>
                <td><code class="literal">closeFolder</code>
                </td>
                <td><code class="literal">true</code>
                </td>
                <td><span class="bold"><strong>Camel 2.10.4:</strong></span> Whether the consumer should close
                    the folder after polling. Setting this option to <code class="literal">false</code> and
                    having <code class="literal">disconnect=false</code> as well, then the consumer keep the
                    folder open between polls. </td>
            </tr><tr>
                <td><code class="literal">mail.XXX</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> Set any <a class="link" href="http://java.sun.com/products/javamail/javadocs/index.html" target="_top">additional java mail properties</a>. For instance if you want to set a
                    special property when using POP3 you can now provide the option directly in the
                    URI such as: <code class="literal">mail.pop3.forgettopheaders=true</code>. You can set
                    multiple such options, for example:
                        <code class="literal">mail.pop3.forgettopheaders=true&amp;mail.mime.encodefilename=true</code>.
                </td>
            </tr><tr>
                <td><code class="literal">mapMailMessage</code>
                </td>
                <td><code class="literal">true</code>
                </td>
                <td>
                    <span class="bold"><strong>Camel 2.8:</strong></span> Specifies whether Camel should map
                    the received mail message to Camel body/headers. If set to true, the body of the
                    mail message is mapped to the body of the Camel IN message and the mail headers
                    are mapped to IN headers. If this option is set to false then the IN message
                    contains a raw <code class="literal">javax.mail.Message</code>. You can retrieve this raw
                    message by calling
                        <code class="literal">exchange.getIn().getBody(javax.mail.Message.class)</code>. </td>
            </tr><tr>
                <td><code class="literal">maxMessagesPerPoll</code>
                </td>
                <td><code class="literal">0</code>
                </td>
                <td> Specifies the maximum number of messages to gather per poll. By default, no
                    maximum is set. Can be used to set a limit of e.g. 1000 to avoid downloading
                    thousands of files when the server starts up. Set a value of 0 or negative to
                    disable this option. </td>
            </tr><tr>
                <td><code class="literal">javaMailSender</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> Specifies a pluggable
                        <code class="literal">org.apache.camel.component.mail.JavaMailSender</code> instance
                    in order to use a custom email implementation. </td>
            </tr><tr>
                <td><code class="literal">ignoreUnsupportedCharset</code>
                </td>
                <td><code class="literal">false</code>
                </td>
                <td> Option to let Camel ignore unsupported charset in the local JVM when sending
                    mails. If the charset is unsupported then <code class="literal">charset=XXX</code> (where
                        <code class="literal">XXX</code> represents the unsupported charset) is removed from
                    the <code class="literal">content-type</code> and it relies on the platform default
                    instead. </td>
            </tr><tr>
                <td><code class="literal">sslContextParameters</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td><span class="bold"><strong>Camel 2.10:</strong></span> Reference to a
                        <code class="literal">org.apache.camel.util.jsse.SSLContextParameters</code> in the
                        <a class="link" href="http://camel.apache.org/registry.html" target="_top">Registry</a>.&nbsp;This reference overrides any configured
                    SSLContextParameters at the component level. See <a class="link" href="http://camel.apache.org/http4.html#HTTP4-UsingtheJSSEConfigurationUtility" target="_top">Using the JSSE Configuration Utility</a>. </td>
            </tr><tr>
                <td><code class="literal">searchTerm</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td><span class="bold"><strong>Camel 2.11:</strong></span> Refers to a
                        <code class="literal">javax.mail.search.SearchTerm</code> which allows to filter mails
                    based on search criteria such as subject, body, from, sent after a certain date
                    etc. See further below for examples. </td>
            </tr><tr>
                <td><code class="literal">searchTerm.xxx</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td><span class="bold"><strong>Camel 2.11:</strong></span> To configure search terms directly
                    from the endpoint uri, which supports a limited number of terms defined by the
                        <code class="literal">org.apache.camel.component.mail.SimpleSearchTerm</code> class.
                    See further below for examples. </td>
            </tr><tr>
                <td><p><code class="code">sortTerm</code></p></td>
                <td><code class="code">null</code></td>
                <td>
                    <p><span class="bold"><strong>Camel 2.15:</strong></span> To configure the sortTerms
                        that IMAP supports to sort the searched mails. You may need to define an
                        array of<code class="code">com.sun.mail.imap.sortTerm</code> in the registry first and
                            <code class="code">#name</code> to reference it in this URI option.</p>
                    <p><span class="bold"><strong>Camel 2.16:</strong></span> You can also specify a comma
                        separated list of sort terms on the URI that Camel will convert internally.
                        For example, to sort descending by date you would use
                            <code class="code">sortTerm=reverse,date</code>. You can use any of the sort terms
                        defined in <code class="code">com.sun.mail.imap.SortTerm</code>.</p>
                </td>
            </tr><tr>
                <td><p><code class="code">postProcessAction</code></p></td>
                <td><code class="code">null</code></td>
                <td><span class="emphasis"><em>Camel 2.15:</em></span> Refers to a<code class="code">org.apache.camel.component.mail.</code>
                    <code class="code">MailBoxPostProcessAction</code> for
                        doing post processing tasks on the mailbox once the normal processing
                        ended.</td>
            </tr><tr>
                <td>
                    <p><code class="code">skipFailedMessage</code></p>
                </td>
                <td><code class="code">false</code></td>
                <td><span class="emphasis"><em>Camel 2.15:</em></span> If the mail consumer cannot retrieve a given
                    mail message, then this option allows to skip the message and move on to
                    retrieve the next mail message. The default behavior would be the consumer
                    throws an exception and no mails from the batch would be able to be routed by
                    Camel.</td>
            </tr><tr>
                <td>
                    <p><code class="code">handleFailedMessage</code></p>
                </td>
                <td><code class="code">false</code></td>
                <td><span class="emphasis"><em>Camel 2.15:</em></span> If the mail consumer cannot retrieve a given
                    mail message, then this option allows to handle the caused exception by the
                    consumer's error handler. By enable the bridge error handler on the consumer,
                    then the Camel routing error handler can handle the exception instead. The
                    default behavior would be the consumer throws an exception and no mails from the
                    batch would be able to be routed by Camel.</td>
            </tr><tr>
                <td>
                    <p><code class="code">dummyTrustManager</code></p>
                </td>
                <td><code class="code">false</code></td>
                <td><span class="bold"><strong>Camel 2.17:</strong></span> To use a dummy security setting for
                    trusting all certificates. Should only be used for development mode, and not
                    production.</td>
            </tr><tr>
                <td>
                    <p><code class="code">idempotentRepository</code></p>
                </td>
                <td><code class="code">null</code></td>
                <td><span class="bold"><strong>Camel 2.17:</strong></span> A pluggable repository
                    org.apache.camel.spi.IdempotentRepository which allows to cluster consuming from
                    the same mailbox, and let the repository coordinate whether a mail message is
                    valid for the consumer to process.</td>
            </tr><tr>
                <td>
                    <p><code class="code">idempotentRepositoryRemoveOnCommit</code></p>
                </td>
                <td><code class="code">true</code></td>
                <td><span class="bold"><strong>Camel 2.17:</strong></span> When using idempotent repository,
                    when the mail message has been successfully processed and is committed, should
                    the message id be removed from the idempotent repository (default) or be kept in
                    the repository. By default it is assumed the message id is unique and has no
                    value to be kept in the repository, because the mail message will be marked as
                    seen/moved or deleted to prevent it from being consumed again. And therefore
                    having the message id stored in the idempotent repository has little value.
                    However this option allows to store the message id, for whatever reason you may
                    have.</td>
            </tr><tr>
                <td>
                    <p><code class="code">mailUidGenerator</code></p>
                </td>
                <td></td>
                <td><span class="bold"><strong>Camel 2.17:</strong></span> A pluggable
                        <code class="code">MailUidGenerator</code> that allows to use custom logic to generate
                    UUID of the mail message.</td>
            </tr></table></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_SSLsupport"></a>SSL support</h2></div></div></div><p>The underlying mail framework is responsible for providing SSL support. &nbsp;ou may
            either configure SSL/TLS support by completely specifying the necessary Java Mail API
            configuration options, or you may provide a configured SSLContextParameters through the
            component or endpoint configuration.</p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_UsingtheJSSEConfigurationUtility"></a>Using the JSSE Configuration Utility</h2></div></div></div><p>As of <span class="bold"><strong>Camel 2.10</strong></span>, the mail component supports SSL/TLS
            configuration through the <a class="link" href="http://camel.apache.org/http4.html#HTTP4-UsingtheJSSEConfigurationUtility" target="_top">Camel JSSE Configuration
            Utility</a>.&nbsp;This utility greatly decreases the amount of component specific
            code you need to write and is configurable at the endpoint and component
            levels.&nbsp;The following examples demonstrate how to use the utility with the mail
            component.</p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Programmaticconfigurationoftheendpoint"></a>Programmatic configuration of the endpoint</h2></div></div></div><pre class="programlisting">
KeyStoreParameters ksp = new KeyStoreParameters();
ksp.setResource("/users/home/server/truststore.jks");
ksp.setPassword("keystorePassword");
TrustManagersParameters tmp = new TrustManagersParameters();
tmp.setKeyStore(ksp);
SSLContextParameters scp = new SSLContextParameters();
scp.setTrustManagers(tmp);
Registry registry = ...
registry.bind("sslContextParameters", scp);
...
from(...)
&nbsp;&nbsp;.to("smtps://smtp.google.com?username=user@gmail.com&amp;password=password&amp;sslContextParameters=#sslContextParameters");
</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_SpringDSLbasedconfigurationofendpoint"></a>Spring DSL based configuration of endpoint</h2></div></div></div><pre class="programlisting">
...
&lt;camel:sslContextParameters id="sslContextParameters"&gt;
  &lt;camel:trustManagers&gt;
    &lt;camel:keyStore resource="/users/home/server/truststore.jks" password="keystorePassword"/&gt;
  &lt;/camel:trustManagers&gt;
&lt;/camel:sslContextParameters&gt;...
...
&lt;to uri="smtps://smtp.google.com?username=user@gmail.com&amp;password=password&amp;sslContextParameters=#sslContextParameters"/&gt;...
</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_ConfiguringJavaMailDirectly"></a>Configuring JavaMail Directly</h2></div></div></div><p>Camel uses SUN JavaMail, which only trusts certificates issued by well known
            Certificate Authorities (the default JVM trust configuration). If you issue your own
            certificates, you have to import the CA certificates into the JVM's Java trust/key store
            files, override the default JVM trust/key store files (see
                <code class="literal">SSLNOTES.txt</code> in JavaMail for details).</p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_MailMessageContent"></a>Mail Message Content</h2></div></div></div><p>Camel uses the message exchange's IN body as the <a class="link" href="http://java.sun.com/javaee/5/docs/api/javax/mail/internet/MimeMessage.html" target="_top">MimeMessage</a> text content. The body is converted to
                <code class="literal">String.class</code>.</p><p>Camel copies all of the exchange's IN headers to the <a class="link" href="http://java.sun.com/javaee/5/docs/api/javax/mail/internet/MimeMessage.html" target="_top">MimeMessage</a> headers.</p><p>The subject of the <a class="link" href="http://java.sun.com/javaee/5/docs/api/javax/mail/internet/MimeMessage.html" target="_top">MimeMessage</a> can be configured using a header property on the IN message. The
            code below demonstrates this:</p><pre class="programlisting">from("direct:a").setHeader("subject", constant(subject)).to("smtp://james2@localhost");
</pre><p>The same applies for other MimeMessage headers such as recipients, so you can use a
            header property as <code class="literal">To</code>:</p><pre class="programlisting">Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
map.put("To", "davsclaus@apache.org");
map.put("From", "jstrachan@apache.org");
map.put("Subject", "Camel rocks");

String body = "Hello Claus.\nYes it does.\n\nRegards James.";
template.sendBodyAndHeaders("smtp://davsclaus@apache.org", body, map);
</pre><p><span class="bold"><strong>Since Camel 2.11</strong></span> When using the MailProducer the send
            the mail to server, you should be able to get the message id of the <a class="link" href="http://java.sun.com/javaee/5/docs/api/javax/mail/internet/MimeMessage.html" target="_top">MimeMessage</a> with the key <code class="literal">CamelMailMessageId</code> from the
            Camel message header.</p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Headerstakeprecedenceoverpreconfiguredrecipients"></a>Headers take precedence over pre-configured recipients</h2></div></div></div><p>The recipients specified in the message headers always take precedence over recipients
            pre-configured in the endpoint URI. The idea is that if you provide any recipients in
            the message headers, that is what you get. The recipients pre-configured in the endpoint
            URI are treated as a fallback.</p><p>In the sample code below, the email message is sent to
                <code class="literal">davsclaus@apache.org</code>, because it takes precedence over the
            pre-configured recipient, <code class="literal">info@mycompany.com</code>. Any
                <code class="literal">CC</code> and <code class="literal">BCC</code> settings in the endpoint URI are
            also ignored and those recipients will not receive any mail. The choice between headers
            and pre-configured settings is all or nothing: the mail component
                <span class="emphasis"><em>either</em></span> takes the recipients exclusively from the headers or
            exclusively from the pre-configured settings. It is not possible to mix and match
            headers and pre-configured settings.</p><pre class="programlisting">        Map&lt;String, Object&gt; headers = new HashMap&lt;String, Object&gt;();
        headers.put("to", "davsclaus@apache.org");

        template.sendBodyAndHeaders("smtp://admin@localhost?to=info@mycompany.com", "Hello World", headers);</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Multiplerecipientsforeasierconfiguration"></a>Multiple recipients for easier configuration</h2></div></div></div><p>It is possible to set multiple recipients using a comma-separated or a
            semicolon-separated list. This applies both to header settings and to settings in an
            endpoint URI. For example:</p><pre class="programlisting">        Map&lt;String, Object&gt; headers = new HashMap&lt;String, Object&gt;();
        headers.put("to", "davsclaus@apache.org ; jstrachan@apache.org ; ningjiang@apache.org");</pre><p>The preceding example uses a semicolon, <code class="literal">;</code>, as the separator
            character.</p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Settingsendernameandemail"></a>Setting sender name and email</h2></div></div></div><p>You can specify recipients in the format, <code class="literal">name &lt;email&gt;</code>, to
            include both the name and the email address of the recipient.</p><p>For example, you define the following headers on the <span class="phrase">Message</span>:</p><pre class="programlisting">Map headers = new HashMap();
map.put("To", "Claus Ibsen &lt;davsclaus@apache.org&gt;");
map.put("From", "James Strachan &lt;jstrachan@apache.org&gt;");
map.put("Subject", "Camel is cool");</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_SUNJavaMail"></a>SUN JavaMail</h2></div></div></div><p>
            <a class="link" href="http://java.sun.com/products/javamail/" target="_top">SUN JavaMail</a> is used under
            the hood for consuming and producing mails. We encourage end-users to consult these
            references when using either POP3 or IMAP protocol. Note particularly that POP3 has a
            much more limited set of features than IMAP.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>
                    <a class="link" href="https://javamail.java.net/nonav/docs/api/com/sun/mail/pop3/package-summary.html" target="_top">SUN POP3 API</a>
                </p></li><li class="listitem"><p>
                    <a class="link" href="https://javamail.java.net/nonav/docs/api/com/sun/mail/imap/package-summary.html" target="_top">SUN IMAP API</a>
                </p></li><li class="listitem"><p>And generally about the <a class="link" href="http://camel.apache.org/mail.html" target="_top">MAIL Flags</a>
                </p></li></ul></div></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Samples"></a>Samples</h2></div></div></div><p>We start with a simple route that sends the messages received from a JMS queue as
            emails. The email account is the <code class="literal">admin</code> account on
                <code class="literal">mymailserver.com</code>.</p><pre class="programlisting">from("jms://queue:subscription").to("smtp://admin@mymailserver.com?password=secret");</pre><p>In the next sample, we poll a mailbox for new emails once every minute. Notice that we
            use the special <code class="literal">consumer</code> option for setting the poll interval,
                <code class="literal">consumer.delay</code>, as 60000 milliseconds = 60 seconds.</p><pre class="programlisting">from("imap://admin@mymailserver.com
     password=secret&amp;unseen=true&amp;consumer.delay=60000")
    .to("seda://mails");</pre><p>In this sample we want to send a mail to multiple recipients: </p><pre class="programlisting">// all the recipients of this mail are:
// To: camel@riders.org , easy@riders.org
// CC: me@you.org
// BCC: someone@somewhere.org
String recipients = "&amp;To=camel@riders.org,easy@riders.org&amp;CC=me@you.org&amp;BCC=someone@somewhere.org";

from("direct:a").to("smtp://you@mymailserver.com?password=secret&amp;From=you@apache.org" + recipients);</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Sendingmailwithattachmentsample"></a>Sending mail with attachment sample</h2></div></div></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Warning: Attachments are not support by all Camel components"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="imagesdb/warning.png"></td><th align="left">Attachments are not support by all Camel components</th></tr><tr><td align="left" valign="top"><p>The <span class="emphasis"><em>Attachments API</em></span> is based on the Java Activation Framework
                and is generally only used by the Mail API. Since many of the other Camel components
                do not support attachments, the attachments could potentially be lost as they
                propagate along the route. The rule of thumb, therefore, is to add attachments just
                before sending a message to the mail endpoint.</p></td></tr></table></div><p>The mail component supports attachments. In the sample below, we send a mail message
            containing a plain text message with a logo file attachment.</p><pre class="programlisting">// create an exchange with a normal body and attachment to be produced as email
Endpoint endpoint = context.getEndpoint("smtp://james@mymailserver.com?password=secret");

// create the exchange with the mail message that is multipart with a file and a Hello World text/plain message.
Exchange exchange = endpoint.createExchange();
Message in = exchange.getIn();
in.setBody("Hello World");
in.addAttachment("logo.jpeg", new DataHandler(new FileDataSource("src/test/data/logo.jpeg")));

// create a producer that can produce the exchange (= send the mail)
Producer producer = endpoint.createProducer();
// start the producer
producer.start();
// and let it go (processes the exchange by sending the email)
producer.process(exchange);</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_SSLsample"></a>SSL sample</h2></div></div></div><p>In this sample, we want to poll our Google mail inbox for mails. To download mail onto
            a local mail client, Google mail requires you to enable and configure SSL. This is done
            by logging into your Google mail account and changing your settings to allow IMAP
            access. Google have extensive documentation on how to do this.</p><pre class="programlisting">from("imaps://imap.gmail.com?username=YOUR_USERNAME@gmail.com&amp;password=YOUR_PASSWORD"
    + "&amp;delete=false&amp;unseen=true&amp;consumer.delay=60000").to("log:newmail");</pre><p>The preceding route polls the Google mail inbox for new mails once every minute and
            logs the received messages to the <code class="literal">newmail</code> logger category. Running
            the sample with <code class="literal">DEBUG</code> logging enabled, we can monitor the progress in
            the logs:</p><pre class="programlisting">2008-05-08 06:32:09,640 DEBUG MailConsumer - Connecting to MailStore imaps//imap.gmail.com:993 (SSL enabled), folder=INBOX
2008-05-08 06:32:11,203 DEBUG MailConsumer - Polling mailfolder: imaps//imap.gmail.com:993 (SSL enabled), folder=INBOX
2008-05-08 06:32:11,640 DEBUG MailConsumer - Fetching 1 messages. Total 1 messages.
2008-05-08 06:32:12,171 DEBUG MailConsumer - Processing message: messageNumber=[332], from=[James Bond &lt;007@mi5.co.uk&gt;], to=YOUR_USERNAME@gmail.com], subject=[...
2008-05-08 06:32:12,187 INFO  newmail - Exchange[MailMessage: messageNumber=[332], from=[James Bond &lt;007@mi5.co.uk&gt;], to=YOUR_USERNAME@gmail.com], subject=[...</pre></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Consumingmailswithattachmentsample"></a>Consuming mails with attachment sample</h2></div></div></div><p>In this sample we poll a mailbox and store all attachments from the mails as files.
            First, we define a route to poll the mailbox. As this sample is based on google mail, it
            uses the same route as shown in the SSL sample:</p><pre class="programlisting">from("imaps://imap.gmail.com?username=YOUR_USERNAME@gmail.com&amp;password=YOUR_PASSWORD"
    + "&amp;delete=false&amp;unseen=true&amp;consumer.delay=60000").process(new MyMailProcessor());</pre><p>Instead of logging the mail we use a processor where we can process the mail from java
            code:</p><pre class="programlisting">    public void process(Exchange exchange) throws Exception {
        // the API is a bit clunky so we need to loop
        Map&lt;String, DataHandler&gt; attachments = exchange.getIn().getAttachments();
        if (attachments.size() &gt; 0) {
            for (String name : attachments.keySet()) {
                DataHandler dh = attachments.get(name);
                // get the file name
                String filename = dh.getName();

                // get the content and convert it to byte[]
                byte[] data = exchange.getContext().getTypeConverter()
                                  .convertTo(byte[].class, dh.getInputStream());

                // write the data to a file
                FileOutputStream out = new FileOutputStream(filename);
                out.write(data);
                out.flush();
                out.close();
            }
        }
   }</pre><p>As you can see the API to handle attachments is a bit clunky but it's there so you can
            get the <code class="literal">javax.activation.DataHandler</code> so you can handle the
            attachments using standard API.</p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_Howtosplitamailmessagewithattachments"></a>How to split a mail message with attachments</h2></div></div></div><p>In this example we consume mail messages which may have a number of attachments. What
            we want to do is to use the <span class="phrase">Splitter</span> EIP per individual attachment, to process the attachments
            separately. For example if the mail message has 5 attachments, we want the <span class="phrase">Splitter</span> to process five
            messages, each having a single attachment. To do this we need to provide a custom <a class="link" href="Expression" target="_top">Expression</a> to the <span class="phrase">Splitter</span>, where we provide a List&lt;Message&gt; that
            contains the five messages with the single attachment.</p><p>The code is provided out of the box in Camel 2.10 onwards in the
                <code class="literal">camel-mail</code> component. The code is in the class:
                <code class="literal">org.apache.camel.component.mail.SplitAttachmentsExpression</code>, which
            you can find the source code <a class="link" href="https://svn.apache.org/repos/asf/camel/trunk/components/camel-mail/src/main/java/org/apache/camel/component/mail/SplitAttachmentsExpression.java" target="_top">here</a>
        </p><p>In the Camel route you then need to use this <a class="link" href="Expression" target="_top">Expression</a> in the route as shown below:</p><pre class="programlisting">from("pop3://james@mymailserver.com?password=secret&amp;consumer.delay=1000")
    .to("log:email")
    // use the SplitAttachmentsExpression which will split the message per attachment
    .split(new SplitAttachmentsExpression())
        // each message going to this mock has a single attachment
        .to("mock:split")
    .end();</pre><p>If you use XML DSL then you need to declare a method call expression in the <span class="phrase">Splitter</span>, as shown
            below</p><pre class="programlisting">&lt;split&gt;
  &lt;method beanType="org.apache.camel.component.mail.SplitAttachmentsExpression"/&gt;
  &lt;to uri="mock:split"/&gt;
&lt;/split&gt;</pre><p>From <span class="bold"><strong>Camel 2.16</strong></span> onwards you can also split the
            attachments as <code class="code">byte[]</code> to be stored as the message body. This is done by
            creating the expression with Boolean <code class="code">true</code>. For example:</p><pre class="programlisting">SplitAttachmentsExpression split = SplitAttachmentsExpression(true);</pre><p>And then use the expression with the Splitter EIP.</p></div><div class="simplesect"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="IDU-Mail_HSH_UsingcustomSearchTerm"></a>Using custom SearchTerm</h2></div></div></div><p><span class="bold"><strong>Available as of Camel 2.11</strong></span>
        </p><p>You can configure a <code class="literal">searchTerm</code> on the
                <code class="literal">MailEndpoint</code> which allows you to filter out unwanted mails. </p><p>For example to filter mails to contain Camel in either Subject or Text you can do as
            follows:</p><pre class="programlisting">&lt;route&gt;
  &lt;from uri="imaps://mymailseerver?username=foo&amp;password=secret&amp;searchTerm.subjectOrBody=Camel"/&gt;
  &lt;to uri="bean:myBean"/&gt;
&lt;/route&gt;</pre><p>Notice we use the <code class="literal">"searchTerm.subjectOrBody"</code> as parameter key to
            indicate that we want to search on mail subject or body, to contain the word "Camel".
            The class <code class="literal">org.apache.camel.component.mail.SimpleSearchTerm</code> has a
            number of options you can configure:</p><p>Or to get the new unseen emails going 24 hours back in time you can do. Notice the
            "now-24h" syntax. See the table below for more details.</p><pre class="programlisting">&lt;route&gt;
  &lt;from uri="imaps://mymailseerver?username=foo&amp;password=secret&amp;searchTerm.fromSentDate=now-24h"/&gt;
  &lt;to uri="bean:myBean"/&gt;
&lt;/route&gt;</pre><p>You can have multiple searchTerm in the endpoint uri configuration. They would then be
            combined together using AND operator, eg so both conditions must match. For example to
            get the last unseen emails going back 24 hours which has Camel in the mail subject you
            can do: </p><pre class="programlisting">&lt;route&gt;
  &lt;from uri="imaps://mymailseerver?username=foo&amp;password=secret&amp;searchTerm.subject=Camel&amp;searchTerm.fromSentDate=now-24h"/&gt;
  &lt;to uri="bean:myBean"/&gt;
&lt;/route&gt;</pre><p>
            
        </p><table id="d0e126390"><tr>
                <th> Option </th>
                <th> Default </th>
                <th> Description </th>
            </tr><tr>
                <td>
                    <code class="code">unseen</code>
                </td>
                <td><code class="literal">true</code>
                </td>
                <td> Whether to limit by unseen mails only. </td>
            </tr><tr>
                <td>
                    <code class="code">subjectOrBody</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> To limit by subject or body to contain the word. </td>
            </tr><tr>
                <td>
                    <code class="code">subject</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> The subject must contain the word. </td>
            </tr><tr>
                <td>
                    <code class="code">body</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> The body must contain the word. </td>
            </tr><tr>
                <td>
                    <code class="code">from</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> The mail must be from a given email pattern. </td>
            </tr><tr>
                <td>
                    <code class="code">to</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> The mail must be to a given email pattern. </td>
            </tr><tr>
                <td>
                    <code class="code">fromSentDate</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> The mail must be sent after or equals (GE) a given date. The date pattern is
                        <code class="literal">yyyy-MM-dd HH:mm:SS</code>, eg use <code class="literal">"2012-01-01
                        00:00:00"</code> to be from the year 2012 onwards. You can use
                        <code class="literal">"now"</code> for current timestamp. The "now" syntax supports an
                    optional offset, that can be specified as either + or - with a numeric value.
                    For example for last 24 hours, you can use <code class="literal">"now - 24h"</code> or
                    without spaces <code class="literal">"now-24h"</code>. Notice that Camel supports
                    shorthands for hours, minutes, and seconds. </td>
            </tr><tr>
                <td>
                    <code class="code">toSentDate</code>
                </td>
                <td><code class="literal">null</code>
                </td>
                <td> The mail must be sent before or equals (BE) a given date. The date pattern is
                        <code class="literal">yyyy-MM-dd HH:mm:SS</code>, eg use <code class="literal">"2012-01-01
                        00:00:00"</code> to be before the year 2012. You can use
                        <code class="literal">"now"</code> for current timestamp. The "now" syntax supports an
                    optional offset, that can be specified as either + or - with a numeric value.
                    For example for last 24 hours, you can use <code class="literal">"now - 24h"</code> or
                    without spaces <code class="literal">"now-24h"</code>. Notice that Camel supports
                    shorthands for hours, minutes, and seconds. </td>
            </tr></table><p>The <code class="literal">SimpleSearchTerm</code> is designed to be easily configurable from a
            POJO, so you can also configure it using a &lt;bean&gt; style in XML</p><pre class="programlisting">&lt;bean id="mySearchTerm" class="org.apache.camel.component.mail.SimpleSearchTerm"&gt;
  &lt;property name="subject" value="Order"/&gt;
  &lt;property name="to" value="acme-order@acme.com"/&gt;
  &lt;property name="fromSentDate" value="now"/&gt;
 &lt;/bean&gt;</pre><p>You can then refer to this bean, using #beanId in your Camel route as shown:</p><pre class="programlisting">&lt;route&gt;
  &lt;from uri="imaps://mymailseerver?username=foo&amp;password=secret&amp;searchTerm=#mySearchTerm"/&gt;
  &lt;to uri="bean:myBean"/&gt;
&lt;/route&gt;</pre><p>In Java there is a builder class to build compound <code class="literal">SearchTerm</code>s
            using the <code class="literal">org.apache.camel.component.mail.SearchTermBuilder</code> class.
            This allows you to build complex terms such as:</p><pre class="programlisting">// we just want the unseen mails which is not spam
SearchTermBuilder builder = new SearchTermBuilder();

builder.unseen().body(Op.not, "Spam").subject(Op.not, "Spam")
  // which was sent from either foo or bar
  .from("foo@somewhere.com").from(Op.or, "bar@somewhere.com");
  // .. and we could continue building the terms

SearchTerm term = builder.build();</pre></div></div></body></html>